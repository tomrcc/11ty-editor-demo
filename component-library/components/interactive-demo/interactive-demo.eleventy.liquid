<section>
  <div
    id="interaction-demo-window"
    x-data="contentManager({})"
    class="relative hidden max-w-screen-lg mx-auto overflow-hidden text-black bg-white border-2 border-black border-solid rounded-lg shadow-lg md:flex md:flex-col"
    style="--shadow-color: rgba(0,0,0,0.1); height: 700px;">
    {% bookshop "interactive-demo/bits/topbar" %}
      <div class="flex items-center justify-between px-3 py-1.5 border-b-2 border-black">
        <div class="flex items-center gap-1">
          <button class="p-1 rounded hover:bg-gray-100" aria-label="Back">
            <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
          </button>
          <button class="p-1 rounded hover:bg-gray-100" @click="toggleSidebar()" aria-label="Toggle sidebar">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
          <span class="text-sm font-semibold">Home</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-xs text-gray-400">No pending changes</span>
          <button class="px-3 py-1 text-xs font-semibold bg-[#e8e8e8] text-gray-400 rounded">Save</button>
        </div>
      </div>
      <div class="relative flex flex-1 min-h-0">
      <!-- Sidebar -->
    {% bookshop "interactive-demo/bits/sidebar" %}
      <!-- Main Content -->
      {% bookshop "interactive-demo/bits/main" %}
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('contentManager', () => ({
        blocks: [
          {
            id: 'block-1',
            type: 'text-block',
            title: '{{ content.text_component.name | escapeQuotes }}',
            label: '{{ content.text_component.label | escapeQuotes }}',
            heading: '{{ content.text_component.text_heading | escapeQuotes }}',
            content: '{{ content.text_component.content | escapeQuotes }}',
            labelId: 'text-block-label',
            headingId: 'preview-title',
            contentId: 'preview-content',
            menuId: 'block-1-menu',
            panelId: 'panel-1',
            previewButtonId: 'preview-button',
            order: 0
          },
          {
            id: 'block-2',
            type: 'image-block',
            title: '{{ content.image_component.name | escapeQuotes }}',
            label: '{{ content.image_component.label | escapeQuotes }}',
            image: '{{ content.image_component.image | escapeQuotes }}',
            labelId: 'image-block-label',
            previewImageId: 'preview-image',
            menuId: 'block-2-menu',
            panelId: 'panel-2',
            order: 1
          }
        ],
        blockCounter: 3,
        blockTypes: [
          { type: 'text-block', name: '{{ content.text_component.name | escapeQuotes }}' },
          { type: 'image-block', name: '{{ content.image_component.name | escapeQuotes }}' },
          { type: 'button-block', name: '{{ content.button_component.name | escapeQuotes }}' }
        ],
        availableBackgroundColors: {{ style.available_background_colors | json }},
        availableButtonColors: {{ style.available_button_colors | json }},
        backgroundColor: (() => {
          const colors = {{ style.available_background_colors | json }};
          const defaultColor = colors.find(color => color.default_background) || { color_value: '{{ style.default_preview_background_color }}' };
          return defaultColor.color_value;
        })(),
        navbarImage: '{{ content.navigation.header_image }}',
        footerImage: '{{ content.navigation.footer_image }}',
        draggedBlockId: null,
        contentAdded: false,
        sidebarOpen: true,
        
        openPanel(panelId) {
          const panel = document.getElementById(panelId);
          const sidebar = document.getElementById('sidebar');
          const sidebarScrollTop = sidebar.scrollTop;
          
          panel.classList.remove('hidden');
          sidebar.style.overflow = 'hidden'; 
          panel.style.top = `${sidebarScrollTop}px`; 
          panel.style.height = '100%'; 
        
          setTimeout(() => {
              panel.classList.remove('translate-x-full');
              panel.classList.add('translate-x-0');
          }, 10);
        },
        
        closePanel() {
          document.querySelectorAll('.component-panel').forEach(panel => {
            panel.classList.remove('translate-x-0');
            panel.classList.add('translate-x-full');
            panel.style.height = '';
            setTimeout(() => panel.classList.add('hidden'), 400);
          });
          const sidebar = document.getElementById('sidebar');
          sidebar.style.overflow = 'auto';
        },
        
        updateLabel(event, blockId) {
          const block = this.blocks.find(b => b.id === blockId);
          if (block) block.label = event.target.value;
        },
        
        handleImageInputClick(event, blockId) {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const block = this.blocks.find(b => b.id === blockId);
              if (block) block.image = URL.createObjectURL(file);
            }
          };
          fileInput.click();
        },
        
        updateButtonColor(event, color, blockId) {
          const block = this.blocks.find(b => b.id === blockId);
          if (block) block.buttonColor = color;
        },
        
        updateBackgroundColor(color) {
          this.backgroundColor = color;
        },
        
        toggleAddContentMenu() {
          document.getElementById('add-content-menu').classList.toggle('hidden');
        },
        
        closeAddContentMenu() {
          document.getElementById('add-content-menu').classList.add('hidden');
        },
        
        toggleSidebar() {
          this.sidebarOpen = !this.sidebarOpen;
          if (!this.sidebarOpen) {
            this.closePanel();
            this.closeAllMenus();
            this.closeAddContentMenu();
          }
        },
        
        addContentBlock(blockType) {
          const newBlock = {
            id: `block-${this.blockCounter}`,
            type: blockType.type,
            title: this.getBlockTitle(blockType.type),
            label: this.getBlockLabel(blockType.type),
            heading: blockType.type === 'text-block' ? '{{ content.text_component.text_heading | escapeQuotes }}' : '',
            content: blockType.type === 'text-block' ? '{{ content.text_component.content | escapeQuotes }}' : '',
            image: blockType.type === 'image-block' ? '{{ content.image_component.image }}' : '',
            buttonText: blockType.type === 'button-block' ? '{{ content.button_component.text | escapeQuotes }}' : '',
            buttonColor: blockType.type === 'button-block' ? '{{ content.button_component.color }}' : '',
            labelId: `block-${this.blockCounter}-label`,
            headingId: `block-${this.blockCounter}-heading`,
            contentId: `block-${this.blockCounter}-content`,
            menuId: `block-${this.blockCounter}-menu`,
            panelId: `panel-${this.blockCounter}`,
            previewButtonId: `preview-button-${this.blockCounter}`,
            previewImageId: `preview-image-${this.blockCounter}`,
            order: this.blockCounter
          };
          this.blocks.push(newBlock);
          this.blockCounter++;
          this.closeAddContentMenu();
        },
        
        getBlockTitle(type) {
          if (type === 'text-block') return '{{ content.text_component.name | escapeQuotes }}';
          if (type === 'image-block') return '{{ content.image_component.name | escapeQuotes }}';
          return '{{ content.button_component.name | escapeQuotes }}';
        },
        
        getBlockLabel(type) {
          if (type === 'text-block') return '{{ content.text_component.label | escapeQuotes }}';
          if (type === 'button-block') return '{{ content.button_component.label | escapeQuotes }}';
          return '{{ content.image_component.label | escapeQuotes }}';
        },
        
        toggleBlockMenu(blockId) {
          const menu = document.getElementById(`${blockId}-menu`);
          this.closeAllMenus();
          menu.classList.toggle('hidden');
        },
        
        closeBlockMenu(blockId) {
          document.getElementById(`${blockId}-menu`).classList.add('hidden');
        },
        
        closeAllMenus() {
          document.querySelectorAll('[id^="block-"][id$="-menu"]').forEach(menu => {
            menu.classList.add('hidden');
          });
        },
        
        moveBlock(blockId, direction) {
          const blockIndex = this.blocks.findIndex(b => b.id === blockId);
          if (blockIndex !== -1) {
            const targetIndex = direction === 'up' ? blockIndex - 1 : blockIndex + 1;
            if (targetIndex >= 0 && targetIndex < this.blocks.length) {
              [this.blocks[blockIndex], this.blocks[targetIndex]] = [this.blocks[targetIndex], this.blocks[blockIndex]];
              this.updateOrder();
            }
          }
        },
        
        deleteBlock(blockId, event) {
          event.stopPropagation();
          this.blocks = this.blocks.filter(b => b.id !== blockId);
          this.updateOrder();
        },
        
        startDragging(event, blockId) {
          this.draggedBlockId = blockId;
          event.target.style.cursor = 'grabbing';
        },
        
        endDragging() {
          this.draggedBlockId = null;
          event.target.style.cursor = 'grab';
        },
        
        reorderBlocks(event) {
          const targetBlockId = event.target.closest('.content-block').id;
          const draggedBlockIndex = this.blocks.findIndex(b => b.id === this.draggedBlockId);
          const targetBlockIndex = this.blocks.findIndex(b => b.id === targetBlockId);
        
          if (draggedBlockIndex !== -1 && targetBlockIndex !== -1) {
            const draggedBlock = this.blocks[draggedBlockIndex];
            this.blocks.splice(draggedBlockIndex, 1);
            this.blocks.splice(targetBlockIndex, 0, draggedBlock);
            this.updateOrder();
          }
        },
        
        updateOrder() {
          this.blocks.forEach((block, index) => {
            block.order = index;
          });
        },
      }));
    });
  </script>

  <style>
    #sidebar .content-block:first-of-type {
      border-top: 2px solid #cfcfcf;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    #sidebar .content-block:last-child {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      border-top: none;
    }

    #sidebar .content-block.middle {
      border-radius: 0;
      border-top: none;
    }

    #sidebar .content-block:not(:first-of-type):hover {
      border-top: 2px solid #616161;
      margin-top: -2px;
    }

    #sidebar .content-block,
    #sidebar .content-block:last-child,
    #sidebar .content-block.single,
    #sidebar .content-block.middle,
    #sidebar .content-block:first-of-type {
       &:hover {
        border-color: #616161;
      }
    }

    #sidebar .content-block.single {
      border-radius: 8px;
      border-top: 2px solid #cfcfcf;
    }

    .select-input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #cfcfcf;
      border-radius: 8px;
      background-color: white;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .rotate-180 {
      transform: rotate(180deg);
    }

    .select-input:hover {
      border-color: #616161;
    }

    .select-input.open {
      border-color: #616161;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      /* border-bottom: none; */
    }

    .component-panel {
      position: absolute;
      height: 100%;
      width: 100%;
      transition: transform 0.4s;
    }

    .editable-region {
      outline: 2px solid transparent;
      outline-offset: 4px;
      transition: outline-color 0.15s ease;
      cursor: pointer;
    }

    .editable-region:hover,
    .editable-region:focus {
      outline-color: #FCBD01;
    }

    .editable-region:focus {
      outline-style: solid;
    }

  </style>

</section>