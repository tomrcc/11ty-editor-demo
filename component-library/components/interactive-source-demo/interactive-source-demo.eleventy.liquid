<section>
  <div
    id="source-demo-window"
    x-data="sourceEditorManager()"
    class="relative hidden max-w-screen-lg mx-auto overflow-hidden text-black bg-white border-2 border-black border-solid rounded-lg shadow-lg md:flex md:flex-col"
    style="--shadow-color: rgba(0,0,0,0.1); height: 700px;">
    {% bookshop "interactive-source-demo/bits/topbar" %}
    <div class="flex items-center justify-between px-3 py-1.5 border-b-2 border-black">
      <div class="flex items-center gap-1">
        <button class="p-1 rounded hover:bg-gray-100" aria-label="Back">
          <svg
            class="w-4 h-4 text-gray-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7" /></svg>
        </button>
        <button
          class="p-1 rounded hover:bg-gray-100"
          @click="toggleSource()"
          aria-label="Toggle source code">
          <svg
            class="w-5 h-5"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
        </button>
        <span class="text-sm font-semibold">index.html</span>
      </div>
      <div class="flex items-center gap-3">
        <span
          class="text-xs"
          :class="hasChanges ? 'text-amber-600 font-semibold' : 'text-gray-400'"
          x-text="hasChanges ? 'Unsaved changes' : 'No pending changes'"></span>
        <button
          class="px-3 py-1 text-xs font-semibold rounded transition-colors"
          :class="hasChanges ? 'bg-[#034AD8] text-white hover:bg-[#0240b8]' : 'bg-[#e8e8e8] text-gray-400'"
          @click="resetChanges()">Save</button>
      </div>
    </div>
    <div class="relative flex flex-1 min-h-0">
      {% bookshop "interactive-source-demo/bits/sidebar" %}
      {% bookshop "interactive-source-demo/bits/main" %}
      <div
        x-show="tutorialStep <= 4"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="tutorial-tooltip"
        :style="'top: ' + tooltipTop() + 'px'">
        <div class="text-sm leading-snug text-gray-700" x-text="tooltipSteps[tutorialStep]?.text"></div>
        <div class="flex items-center justify-between mt-3">
          <span class="text-xs text-gray-400" x-text="(tutorialStep + 1) + ' / 5'"></span>
          <button
            class="px-3 py-1 text-xs font-semibold text-white rounded"
            style="background-color: #034AD8;"
            @click="nextStep()"
            x-text="tooltipSteps[tutorialStep]?.button"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('sourceEditorManager', () => ({
        sourceOpen: true,
        hasChanges: false,
        lastEditedProp: null,
        flashTimeout: null,
        tutorialStep: 0,
        lastAdvancedStep: null,
        advanceTimeout: null,
        heading: '{{ content.page.title | escapeQuotes }}',
        description: '{{ content.page.description | escapeQuotes }}',
        buttonText: '{{ content.page.button_text | escapeQuotes }}',
        heroImage: '{{ content.page.hero_image }}',
        navbarImage: '{{ content.navigation.header_image }}',
        footerImage: '{{ content.navigation.footer_image }}',

        tooltipSteps: [
          { text: 'This HTML page has hard-coded content. Let\u2019s make the heading editable with Source Editable Regions.', button: 'Start' },
          { text: 'This attribute tells CloudCannon that this element\u2019s content can be edited directly in the source.', button: 'Next' },
          { text: 'This tells CloudCannon which source file the content lives in.', button: 'Next' },
          { text: 'This unique key identifies the editable region. Each region in a file needs its own key.', button: 'Next' },
          { text: 'Your heading is set up! Try editing it on the right \u2014 the source updates in real time.', button: 'Try it' },
        ],

        get sourceLines() {
          const s = this.tutorialStep;
          const adv = this.lastAdvancedStep;
          const lines = [];

          lines.push(
            { text: '<nav>' },
            { text: '  <img src="/logo.svg" alt="My Site" />' },
            { text: '</nav>' },
            { text: '' },
            { text: '<section>' },
          );

          if (s >= 3) {
            lines.push(
              { text: '  <h1 data-editable="source"' },
              { text: '      data-path="/index.html"' },
              { text: '      data-key="title">', isNew: adv === 3 },
              { text: '    ' + this.heading, prop: 'heading' },
              { text: '  </h1>' },
            );
          } else if (s === 2) {
            lines.push(
              { text: '  <h1 data-editable="source"' },
              { text: '      data-path="/index.html">', isNew: adv === 2 },
              { text: '    ' + this.heading, prop: 'heading' },
              { text: '  </h1>' },
            );
          } else if (s === 1) {
            lines.push(
              { text: '  <h1 data-editable="source">', isNew: adv === 1 },
              { text: '    ' + this.heading, prop: 'heading' },
              { text: '  </h1>' },
            );
          } else {
            lines.push({ text: '  <h1>' + this.heading + '</h1>' });
          }

          lines.push({ text: '  <p>' + this.description + '</p>' });
          lines.push({ text: '  <img src="/hero.svg" alt="Hero" />' });
          lines.push({ text: '  <button>' + this.buttonText + '</button>' });

          lines.push(
            { text: '</section>' },
            { text: '' },
            { text: '<footer>' },
            { text: '  <p>&copy; 2025 My Site</p>' },
            { text: '</footer>' },
          );

          return lines;
        },

        nextStep() {
          if (this.tutorialStep > 4) return;
          this.tutorialStep++;
          if (this.tutorialStep >= 1 && this.tutorialStep <= 3) {
            this.lastAdvancedStep = this.tutorialStep;
            clearTimeout(this.advanceTimeout);
            this.advanceTimeout = setTimeout(() => {
              this.lastAdvancedStep = null;
            }, 1500);
          }
        },

        tooltipTop() {
          const lineH = 24;
          const tabH = 32;
          switch (this.tutorialStep) {
            case 0: return tabH + 4 * lineH;
            case 1: return tabH + 5 * lineH;
            case 2: return tabH + 6 * lineH;
            case 3: return tabH + 7 * lineH;
            case 4: return tabH + 4 * lineH;
            default: return 0;
          }
        },

        onEdit(prop) {
          this.hasChanges = true;
          this.lastEditedProp = prop;
          clearTimeout(this.flashTimeout);
          this.flashTimeout = setTimeout(() => {
            this.lastEditedProp = null;
          }, 1500);
        },

        resetChanges() {
          this.hasChanges = false;
        },

        toggleSource() {
          this.sourceOpen = !this.sourceOpen;
        }
      }));
    });
  </script>

  <style>
    .editable-region {
      outline: 2px solid transparent;
      outline-offset: 4px;
      transition: outline-color 0.15s ease;
      cursor: pointer;
    }

    .editable-region:hover,
    .editable-region:focus {
      outline-color: #FCBD01;
    }

    .editable-region:focus {
      outline-style: solid;
    }

    .tutorial-tooltip {
      position: absolute;
      z-index: 20;
      left: calc(50% + 12px);
      width: 260px;
      padding: 14px 16px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.18);
      transition: top 0.3s ease;
    }

    .tutorial-tooltip::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 18px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid #fff;
    }
  </style>

</section>
